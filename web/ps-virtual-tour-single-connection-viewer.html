<!DOCTYPE HTML>
<html lang="en">
	<head>
		<title>WebGL SpinMovie Viewer</title>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<style type="text/css">
			body {
				color: black;
				font-family:Arial;
				font-size:13px;
				font-weight: normal;
				margin: 0px;
				padding: 0px;
				overflow: hidden;
				background-color: #313131;
			}

			#container {
				background-color: black;
				text-align: center;
				position: relative;
			}

			#container canvas {
				display: inline-block;
				cursor: -webkit-grab;
			}
		</style>

		<!-- ps2 viewing + annotation viewing -->
		<link rel="stylesheet" type="text/css" href="../css/PS2PacketPlayer.css" />

	</head>

	<body>
		<button id="transition-button" style="position: absolute; z-index: 500; top: 10px; right: 10px; background-color: #ff00ff; min-width: 150px; min-height: 30px;" onclick="transition(this)">Transition!</button>
		<div id="viewer-container"></div>

		<script type="text/javascript" src="js/getUrlParams.js"></script>
		<script type="text/javascript">var _useCompileJS = getUrlParams().compiled === "1";</script>
		<script type="text/javascript" src="js/embedScripts.js"></script>

		<script type="text/javascript" src="js/connections/SynthConnectionDataset.js"></script>
		<script type="text/javascript" src="js/connections/SynthConnectionCamera.js"></script>
		<script type="text/javascript" src="js/connections/SynthConnectionTransform.js"></script>
		<script type="text/javascript" src="js/connections/SynthConnectionPreloader.js"></script>
		<script type="text/javascript" src="js/connections/SynthSingleConnectionViewer.js"></script>
		<script type="text/javascript" src="js/connections/SynthTransitionStore.js"></script>

		<script type="text/javascript">

		var datasetIndex = PS.Utils.getUrlParams().index || 0;
		var _transitionViewer;

		new PS.Utils.Request("connections/"+datasetIndex+".json", {
			onComplete: function(xhr) {
				var json = JSON.parse(xhr.responseText);
				var connection = new PS.Packet.SynthConnectionTransform(json);
				var viewerDiv = document.getElementById("viewer-container");
				_transitionViewer = new PS.Packet.SynthSingleConnectionViewer(viewerDiv, connection, {
					displayTargetCameras: true,
					pathToWorker: "../src/PacketPlayer/PacketViewer/WorkerParser.js",
					transition: {
						duration: 1000,
						forward: {
							onProgress: function(percent, srcDataset, dstDataset) {
								var color = srcDataset.getDominantColor().lerp(dstDataset.getDominantColor(), percent);
								_transitionViewer.player.setBackgroundColor(color);
							},
							onComplete: function(srcDataset, dstDataset) {
								window.history.pushState(null, null, "targetSynth");
							}
						},
						reverse: {
							onProgress: function(percent, srcDataset, dstDataset) {
								var color = srcDataset.getDominantColor().lerp(dstDataset.getDominantColor(), percent);
								_transitionViewer.player.setBackgroundColor(color);
							},
							onComplete: function(srcDataset, dstDataset) {
								document.getElementById("transition-button").disabled = "";
							}
						}
					}
				});
			}
		});

		function transition(btn) {
			_transitionViewer.forwardTransition();
			btn.disabled = true;
		}

		window.addEventListener("popstate", function(e) {
			e.preventDefault();
			_transitionViewer.reverseTransition();
		});

		</script>
	</body>
</html>
