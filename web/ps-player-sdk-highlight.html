<!DOCTYPE html>
<html>
	<head>
		<title>Photosynth user library</title>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
		<meta charset="utf-8">

		<style>
		* {
			margin: 0px;
			padding: 0px;
		}

		html, body {
			font: 16px 'wf_segoe-ui_light','Segoe UI Light','Segoe WP Light','Segoe UI','Segoe WP',Tahoma,Arial,sans-serif;
			overflow: none;
			-ms-content-zooming: none;
			-ms-touch-action: none;
			touch-action: none;
		}

		#viewer-container {
			position: absolute;
			top: 0;
			left: 0;
		}
		</style>

		<script type="text/javascript" src="js/getUrlParams.js"></script>
		<script type="text/javascript">var _useCompileJS = getUrlParams().compiled === "1";</script>
		<script type="text/javascript" src="js/embedScripts.js"></script>

		<!-- ps2 viewing + annotation viewing -->
		<link rel="stylesheet" type="text/css" href="../css/PS2PacketPlayer.css" />

		<!-- annotation creation / edition -->
		<link rel="stylesheet" type="text/css" href="../css/PS2AnnotationEditor.css" />

	</head>
	<body>
		<div id="viewer-container"></div>

		<script>

		var _params = PS.Utils.getUrlParams();
		var _guid   = _params.guid || "19d5cf2b-77ed-439f-ac21-d3046320384c";
		var _startCameraIndex = _params.startat ? parseInt(_params.startat, 10) : -1;
		var _annotationEditingEnabled = _params.edit ? _params.edit === "1" : true;

		PS.API.SimpleAnnotationStorage.init(_annotationStorageURL, _annotationStoragePort); //test if node annotation storage service is running
		PS.API.SimpleSynthLinker.init(_simpleSynthLinkerURL, _simpleSynthLinkerPort);       //test if node synth linking service is running

		var _container = document.getElementById("viewer-container");

		//create synth viewer
		var _viewer = new Photosynth.PS2Viewer(_container, {
			width:  window.innerWidth,
			height: window.innerHeight,
			animateSpeed: 1.0,
			autoStart: false,
			pathToWorker: "../src/PacketPlayer/PacketViewer/WorkerParser.js",
			autoResizeEnabled: true,
			annotateEnabled: _annotationEditingEnabled,
			debugMenuEnabled: true
		});

		_viewer.addEventListener("camera-changed", function(cam, sIndex) {
			window.history.replaceState(null, null, "?guid="+_guid+"&startat="+sIndex);
		});

		//create the annotation viewer
		//(you need to create the annotation viewer before loading a synth = before calling _viewer.loadGuid)
		var _annotationViewer = new Photosynth.PS2AnnotationViewer(_viewer, {
			editEnabled: _annotationEditingEnabled,
			visibleInFullscreen: true
		});

		//load some annotations in the annotation viewer
		_annotationViewer.addEventListener("init", function() {

				//loading annotations from storage
				PS.API.SimpleAnnotationStorage.load(_guid, function (annotations) {
					_annotationViewer.load(annotations);
				});

				/*
				//loading annotations from photosynth.net
				PS.API.SimpleAnnotationProxy.load(_guid, function (annotations) {
					_annotationViewer.load(annotations);
				});
				*/

		});

		if (_annotationEditingEnabled) {
			var _annotationEditor = new Photosynth.PS2AnnotationEditor(_viewer, _annotationViewer, _container);

			_annotationEditor.addEventListener("annotation-created", function(annotation, thumbInfo, callback) {
				PS.API.SimpleAnnotationStorage.insert(_guid, annotation, thumbInfo, function(dbid) {
					callback(true, dbid); //first parameter = succeed or not
				});
			});

			_annotationEditor.addEventListener("annotation-edited", function(annotation, thumbInfo, callback) {
				PS.API.SimpleAnnotationStorage.update(_guid, annotation, function(dbid) {
					callback(true, dbid);
				});
			});

			_annotationEditor.addEventListener("annotation-delete", function(annotation, callback) {
				if (window.confirm("Do you really want to delete this annotation ?")) {
					callback(true); //this will remove the annotation from the viewer

					PS.API.SimpleAnnotationStorage.remove(_guid, annotation);
				}
				else {
					callback(false);
				}
			});

			_annotationEditor.addEventListener("synth-connection-requested", function(request, dbid) {
				request.source.guid = _guid;
				request.source.annotationDBID = dbid;

				//create a connection between 2 synths
				PS.API.SimpleSynthLinker.create(request);
			});
		}

		//load the synth in the viewer
		_viewer.loadGuid(_guid, {
			startCameraIndex: _startCameraIndex
		});

		</script>

	</body>
</html>
